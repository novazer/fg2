<ng-container *ngIf="deviceSettings">

  <ion-card *ngIf="errorLoading">
    <ion-card-header>
      <ion-card-title>{{'misc.errorOccurred' | translate}}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>{{'misc.unableToLoadSettings' | translate}}</p>
    </ion-card-content>
  </ion-card>

  <div class="save-overlay" *ngIf="saving || loading">
    <div class="inner">
      <p><ion-spinner color="light"></ion-spinner></p>
      <p *ngIf="saving">{{'misc.saving' | translate}}</p>
      <p *ngIf="loading">{{'misc.loading' | translate}}</p>
    </div>
  </div>

  <ion-card>
    <ion-card-header>
      <ion-card-title>{{'devices.fridge.settingsmode' | translate}}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-select [(ngModel)]="settingsmode" [interfaceOptions]="{'cssClass': 'wider-popover'}" (ionChange)="onSettingsModeChange()">
          <ion-select-option value="manual">{{'devices.fridge.settingsmode-manual' | translate}}</ion-select-option>
          <ion-select-option value="recipe">{{'devices.fridge.settingsmode-recipe' | translate}} (Beta)</ion-select-option>
        </ion-select>
      </ion-item>
      <ion-item *ngIf="settingsmode === 'recipe'" lines="none">
        <ion-text>
          <br/>
          <ion-icon name="warning" color="warning"></ion-icon>
          {{'devices.fridge.recipe.warning' | translate}}
        </ion-text>
      </ion-item>
      <ion-item *ngIf="settingsmode === 'manual'" lines="none">
        <ion-text>
          <br/>
          <ion-icon name="warning" color="warning"></ion-icon>
          {{'devices.fridge.manualModeOfflineWarning' | translate}}
        </ion-text>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="settingsmode === 'recipe'">
    <ion-card-header>
      <ion-card-title> {{'devices.fridge.recipe.title' + (recipe.activeSince > 0 ? '-active' : '-inactive') | translate}}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- Active step and starting time -->
      <ion-item lines="none">
        <ion-label>{{'devices.fridge.recipe.activeStep' | translate}}</ion-label>
        <ion-select [(ngModel)]="recipe.activeStepIndex" class="ion-text-right" style="width: 150px;" (ionChange)="onActiveStepChanged()">
          <ion-select-option *ngFor="let step of recipe.steps; let i = index" [value]="i">
            #{{i + 1}} {{step.name}}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item lines="none">
        <ion-label>{{ 'devices.fridge.recipe.loop' | translate}}</ion-label>
        <ion-checkbox [(ngModel)]="recipe.loop"></ion-checkbox>
      </ion-item>

      <ion-item lines="none">
        <ion-label>{{ 'devices.fridge.recipe.emailNotifications' | translate}}</ion-label>
        <ion-select [(ngModel)]="recipe.notifications" class="ion-text-right" style="width: 150px;">
          <ion-select-option [value]="'off'">{{ 'devices.fridge.recipe.emailNotifications-none' | translate}}</ion-select-option>
          <ion-select-option [value]="'onStep'">{{ 'devices.fridge.recipe.emailNotifications-onStep' | translate}}</ion-select-option>
          <ion-select-option [value]="'onConfirmation'">{{ 'devices.fridge.recipe.emailNotifications-onConfirmation' | translate}}</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item lines="none" *ngIf="recipe.notifications !== 'off'">
        <ion-label>{{ 'devices.fridge.recipe.emailAddress' | translate}}</ion-label>
        <ion-input type="email" [(ngModel)]="recipe.email" class="ion-text-right"></ion-input>
      </ion-item>

      <!-- Start time: show activeSince as disabled read-only datetime only when running -->
      <ion-item lines="none">
        <ion-label>{{'devices.fridge.recipe.startTime' | translate}}</ion-label>
        <div class="ion-text-right">{{ getActiveSinceISO() ? (getActiveSinceISO() | date:'dd.MM.YYY - HH:mm') : ('devices.fridge.recipe.notRunning' | translate) }}</div>
      </ion-item>

      <ion-item lines="none">
        <ion-label>{{'devices.fridge.recipe.etaTime' | translate}}</ion-label>
        <div class="ion-text-right">{{ getRecipeEtaTimeIso() | date:'dd.MM.YYY - HH:mm' }}</div>
      </ion-item>

      <ion-item lines="none">
        <ion-label>{{'devices.fridge.recipe.remainingTime' | translate}}</ion-label>
        <div class="ion-text-right">{{ msToDuration(getRecipeRemainingTimeMs()) }}</div>
      </ion-item>

      <ion-item *ngIf="stepWaitingForConfirmation(recipe.steps[recipe.activeStepIndex])" lines="none">
        <ion-label>{{'devices.fridge.recipe.waitingForConfirmation' | translate}}</ion-label>
        <ion-text color="warning" class="ion-text-right"> {{recipe.steps[recipe.activeStepIndex].confirmationMessage || 'Please confirm' }} </ion-text>
      </ion-item>

      <ion-button *ngIf="stepWaitingForConfirmation(recipe.steps[recipe.activeStepIndex])" expand="block" color="warning" (click)="confirmCurrentStep()">{{'devices.fridge.recipe.confirmStep' | translate}}</ion-button>

      <ion-item-divider>
        <ion-label>{{ 'devices.fridge.recipe.steps' | translate }}</ion-label>
      </ion-item-divider>

      <ion-accordion-group (ionChange)="onRecipeStepOpened($event)">
        <ion-accordion *ngFor="let step of recipe.steps; let i = index" toggle-icon-slot="end">
          <ion-item slot="header" [color]="recipe.activeStepIndex === i ? recipe.activeSince > 0 ? 'success' : 'medium' : 'light'">
            <ion-label>
              #{{i + 1}}
              {{ step.name }}
              [{{ calculateTimeRemaining(step) }}]

              <ion-text style="font-size: 0.75em; float: right; white-space: normal; max-width: 100%" *ngIf="step.settings">
                ({{ 'devices.fridge.workmode-' + (step.settings?.workmode ?? 'off') | translate }}<span *ngIf="step.settings?.workmode === 'off'">)</span>

                <span *ngIf="step.settings?.workmode !== 'off'"> |
                  <span *ngIf="parseWorkmode(step.settings?.workmode).hasDaycycle">
                    <span *ngIf="step.settings?.daynight?.floating">
                      {{
                        secondsToTimeString(step.settings?.daynight?.light_duration ?? 0, false)
                      }}/{{
                        secondsToTimeString((step.settings?.daynight?.day_duration ?? 0) - (step.settings?.daynight?.light_duration ?? 0), false)
                      }}
                      (floating)
                    </span>
                    <span *ngIf="!step.settings?.daynight?.floating">
                      {{ secondsToTimeString(step.settings?.daynight?.day ?? 0, true) }} -
                      {{ secondsToTimeString(step.settings?.daynight?.night ?? 0, true) }}
                    </span> |
                  </span>
                  <span *ngIf="parseWorkmode(step.settings?.workmode).hasDaycycle">{{ step.settings?.day?.temperature ?? 'n/a' }}&deg;/</span>{{ step.settings?.night?.temperature ?? 'n/a' }}&deg;C |
                  <span *ngIf="parseWorkmode(step.settings?.workmode).hasHumidity">
                    <span *ngIf="parseWorkmode(step.settings?.workmode).hasDaycycle">{{ step.settings?.day?.humidity ?? 'n/a' }}%/</span>{{ step.settings?.night?.humidity ?? 'n/a' }}% RLF |
                  </span>
                  <span *ngIf="parseWorkmode(step.settings?.workmode).hasDaycycle">Light: {{ step.settings?.lights.limit}}% | </span>
                  <span *ngIf="parseWorkmode(step.settings?.workmode).hasCo2">{{ step.settings?.co2?.target }}PPM |</span>
                  Ext. V.: {{ step.settings?.fans?.external }}%, Int. V.: {{ step.settings?.fans?.internal }}%)
                </span>
              </ion-text>
            </ion-label>
          </ion-item>
          <div class="ion-padding" slot="content">
            <ion-item lines="none">
              <ion-label>{{'devices.fridge.recipe.step.name' | translate}}</ion-label>
              <ion-input type="text" [(ngModel)]="step.name" class="ion-text-right"></ion-input>
            </ion-item>

            <ion-item lines="none">
              <ion-label>{{'devices.fridge.recipe.step.waitForConfirmation' | translate}}</ion-label>
              <ion-checkbox [(ngModel)]="step.waitForConfirmation"></ion-checkbox>
            </ion-item>

            <ion-item lines="none" [hidden]="!step.waitForConfirmation">
              <ion-label>{{'devices.fridge.recipe.step.confirmationMessage' | translate}}</ion-label>
              <ion-input type="text" [(ngModel)]="step.confirmationMessage" class="ion-text-right"></ion-input>
            </ion-item>

            <ion-item lines="none">
              <ion-label>{{'devices.fridge.recipe.step.duration' | translate}}</ion-label>
              <ion-input type="number" [(ngModel)]="step.duration" class="ion-text-right"></ion-input>
              <ion-select [(ngModel)]="step.durationUnit" class="ion-text-right" style="width: 100px; margin-left: 10px;">
                <ion-select-option value="minutes">{{'devices.fridge.recipe.step.durationUnit.minutes' | translate}}</ion-select-option>
                <ion-select-option value="hours">{{'devices.fridge.recipe.step.durationUnit.hours' | translate}}</ion-select-option>
                <ion-select-option value="days">{{'devices.fridge.recipe.step.durationUnit.days' | translate}}</ion-select-option>
                <ion-select-option value="weeks">{{'devices.fridge.recipe.step.durationUnit.weeks' | translate}}</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item lines="none" *ngIf="recipe.activeSince > 0">
              <ion-label>{{'devices.fridge.recipe.stepEtaTime' | translate}}</ion-label>
              <div class="ion-text-right">{{ getRecipeEtaTimeIso(i) | date:'dd.MM.YYY - HH:mm' }}</div>
            </ion-item>

            <ion-item lines="none">
              <ion-label>{{'devices.fridge.recipe.stepRemainingTime' | translate}}</ion-label>
              <div class="ion-text-right">{{ msToDuration(getRecipeRemainingTimeMs(i)) }}</div>
            </ion-item>

            <div>
              <ion-button size="small" color="primary" [hidden]="!settingsOpened" (click)="closeSettings()">{{'devices.fridge.recipe.step.closeSettings' | translate}}</ion-button>
              <ion-button size="small" color="secondary" [hidden]="settingsOpened" (click)="openSettings()">{{'devices.fridge.recipe.step.editSettings' | translate}}</ion-button>
              <ion-button size="small" color="tertiary" (click)="moveRecipeStep(i, -1)" [disabled]="i === 0">{{'devices.fridge.recipe.step.moveUp' | translate}}</ion-button>
              <ion-button size="small" color="tertiary" (click)="moveRecipeStep(i, 1)" [disabled]="i === recipe.steps.length - 1">{{'devices.fridge.recipe.step.moveDown' | translate}}</ion-button>
              <ion-button size="small" color="danger" (click)="removeRecipeStep(step)" [disabled]="recipe.activeStepIndex === i && recipe.activeSince > 0">{{'devices.fridge.recipe.deleteStep' | translate}}</ion-button>
            </div>

            <fridge-settings-config *ngIf="settingsOpened" [(deviceSettings)]="step.settings" />

            <ion-button color="primary" expand="block" [hidden]="!settingsOpened" (click)="settingsOpened = false">{{'devices.fridge.recipe.step.closeSettings' | translate}}</ion-button>
          </div>
        </ion-accordion>
      </ion-accordion-group>

      <!-- Add step + run controls -->
      <div [hidden]="settingsmode !== 'recipe' || settingsOpened">
        <ion-item-divider />

        <ion-button size="small" color="primary" (click)="addRecipeStep()">{{'devices.fridge.recipe.addStep' | translate}}</ion-button>

        <!-- New: Load / Save template buttons -->
        <ion-button size="small" color="tertiary" (click)="openLoadTemplateModal()">{{'devices.fridge.recipe.loadTemplate' | translate}}</ion-button>
        <ion-button size="small" color="secondary" (click)="openSaveTemplateModal(false)">{{'devices.fridge.recipe.savePrivateTemplate' | translate}}</ion-button>
        <ion-button size="small" color="secondary" (click)="openSaveTemplateModal(true)">{{'devices.fridge.recipe.savePublicTemplate' | translate}}</ion-button>

        <ion-button size="small" color="success"
                    (click)="setRunning(true)"
                    [hidden]="recipe.activeSince > 0"
                    [disabled]="recipe.steps.length === 0">
          {{'devices.fridge.recipe.step.setRunning' | translate}}
        </ion-button>
        <ion-button size="small" color="danger"
                    (click)="setRunning(false)"
                    [hidden]="recipe.activeSince <= 0">
          {{'devices.fridge.recipe.step.clearRunning' | translate}}
        </ion-button>
      </div>

    </ion-card-content>
  </ion-card>

  <fridge-settings-config *ngIf="settingsmode === 'manual'" [(deviceSettings)]="deviceSettings" />

  <ion-card>
    <ion-card-header>
      <ion-card-title> {{'settings.firmwareUpdates' | translate}}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="none">
        <ion-label>{{'settings.autoFirmwareUpdates' | translate}}</ion-label>
        <ion-checkbox [(ngModel)]="firmwareSettings.autoUpdate"></ion-checkbox>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="alarms !== null">
    <ion-card-header>
      <ion-card-title> {{'settings.alarms.title' | translate}}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-button color="primary" (click)="addAlarm()">{{'settings.alarms.add' | translate}}</ion-button>
      <ion-card *ngFor="let alarm of alarms">

        <ion-card-content>

          <ion-item lines="none">
            <ion-label>{{'settings.alarms.name' | translate}}</ion-label>
            <ion-input type="text" [(ngModel)]="alarm.name" class="ion-text-right" [disabled]="alarm.disabled"></ion-input>
          </ion-item>

          <ion-item lines="none">
            <ion-label>{{'settings.alarms.sensorType' | translate}}</ion-label>
            <ion-select [(ngModel)]="alarm.sensorType" [disabled]="alarm.disabled">
              <ion-select-option *ngFor="let sensorType of availableSensorTypes" [value]="sensorType">
                {{sensorType}}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item lines="none">
            <ion-label>{{'settings.alarms.upperThreshold' | translate}}</ion-label>
            <ion-button fill="clear" id="upperThreshold-popover-{{alarm.alarmId}}">
              <ion-icon name="help-circle-outline"></ion-icon>
            </ion-button>
            <ion-input type="number" [(ngModel)]="alarm.upperThreshold" class="ion-text-right" [disabled]="alarm.disabled"></ion-input>
            <ion-popover trigger="upperThreshold-popover-{{alarm.alarmId}}" [dismissOnSelect]="true">
              <ng-template>
                <ion-content>
                  {{'settings.alarms.upperThresholdHint' | translate}}
                </ion-content>
              </ng-template>
            </ion-popover>
          </ion-item>

          <ion-item lines="none">
            <ion-label>{{'settings.alarms.lowerThreshold' | translate}}</ion-label>
            <ion-button fill="clear" id="lowerThreshold-popover-{{alarm.alarmId}}">
              <ion-icon name="help-circle-outline"></ion-icon>
            </ion-button>
            <ion-input type="number" [(ngModel)]="alarm.lowerThreshold" class="ion-text-right" [disabled]="alarm.disabled"></ion-input>
            <ion-popover trigger="lowerThreshold-popover-{{alarm.alarmId}}" [dismissOnSelect]="true">
              <ng-template>
                <ion-content>
                  {{'settings.alarms.lowerThresholdHint' | translate}}
                </ion-content>
              </ng-template>
            </ion-popover>
          </ion-item>

          <ion-item lines="none">
            <ion-label>{{'settings.alarms.actionType' | translate}}</ion-label>
            <ion-select [(ngModel)]="alarm.actionType" [disabled]="alarm.disabled">
              <ion-select-option value="info">{{'settings.alarms.actionTypeInfo' | translate}}</ion-select-option>
              <ion-select-option value="email">{{'settings.alarms.actionTypeEmail' | translate}}</ion-select-option>
              <ion-select-option value="webhook">{{'settings.alarms.actionTypeWebhook' | translate}}</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item lines="none" [hidden]="alarm.actionType === 'info'">
            <ion-label [color]="(!alarm.actionTarget && alarm.actionType !== 'info' && !alarm.disabled) ? 'danger' : ''">
              {{'settings.alarms.actionTarget' | translate}}
            </ion-label>
            <ion-button fill="clear" id="actionTarget-popover-{{alarm.alarmId}}">
              <ion-icon name="help-circle-outline"></ion-icon>
            </ion-button>
            <ion-input [type]="alarm.actionType === 'email' ? 'email' : alarm.actionType === 'webhook' ? 'url' : 'text'"
                       [required]="alarm.actionType !== 'info' && !alarm.disabled"
                       [(ngModel)]="alarm.actionTarget" class="ion-text-right" [disabled]="alarm.disabled"></ion-input>
            <ion-popover trigger="actionTarget-popover-{{alarm.alarmId}}" [dismissOnSelect]="true">
              <ng-template>
                <ion-content>
                  {{'settings.alarms.actionTargetHint' | translate}}
                </ion-content>
              </ng-template>
            </ion-popover>
          </ion-item>

          <ion-item lines="none" [hidden]="alarm.actionType === 'info'">
            <ion-label>{{'settings.alarms.additionalInfo' | translate}}</ion-label>
            <ion-checkbox [(ngModel)]="alarm.additionalInfo" [disabled]="alarm.disabled"></ion-checkbox>
          </ion-item>

          <ion-item lines="none">
            <ion-label>{{'settings.alarms.cooldownSeconds' | translate}}</ion-label>
            <ion-button fill="clear" id="cooldownSeconds-popover-{{alarm.alarmId}}">
              <ion-icon name="help-circle-outline"></ion-icon>
            </ion-button>
            <ion-input type="number" [(ngModel)]="alarm.cooldownSeconds" class="ion-text-right" [disabled]="alarm.disabled"></ion-input>
            <ion-popover trigger="cooldownSeconds-popover-{{alarm.alarmId}}" [dismissOnSelect]="true">
              <ng-template>
                <ion-content>
                  {{'settings.alarms.cooldownSecondsHint' | translate}}
                </ion-content>
              </ng-template>
            </ion-popover>
          </ion-item>

          <ion-button color="danger" (click)="removeAlarm(alarm)">{{'settings.alarms.delete' | translate}}</ion-button>
          <ion-button [color]="alarm.disabled ? 'primary' : 'light'" (click)="toggleAlarm(alarm)">{{'settings.alarms.' + (alarm.disabled ? 'enable' : 'disable') | translate}}</ion-button>

        </ion-card-content>
      </ion-card>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="errorSaving">
    <ion-card-header>
      <ion-card-title>{{'misc.errorOccurred' | translate}}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>{{'misc.unableToSaveSettings' | translate}}</p>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-content>
      <ion-button color="secondary" expand="block" (click)="saveSettings();">{{'misc.save' | translate}}</ion-button>
      <!-- <ion-button color="danger" expand="block" (click)="resetForm();">{{'buttons.revert' | translate}}</ion-button> -->
    </ion-card-content>
  </ion-card>

</ng-container>
